generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  extensions = [vector]
}

enum Role {
  MAINTAINER
  SUPER_ADMIN
  GROUP_ADMIN
  SUPERVISOR
  STAFF
}

enum ContentStatus {
  DRAFT
  PENDING_APPROVAL
  PUBLISHED
  REJECTED
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

enum SuggestionStatus {
  PENDING
  ACCEPTED
  REJECTED
}

enum NotificationType {
  CONTENT_APPROVAL
  CONTENT_PUBLISHED
  QUIZ_ASSIGNED
  MANDATORY_READ
  AI_QUOTA_LOW
  BILLING_REMINDER
  REVISION_SUGGESTION
}

model Organization {
  id                               String        @id @default(uuid())
  name                             String
  slug                             String        @unique
  industry_segment                 String
  subscription_status              String
  subscription_expires_at          DateTime?
  ai_provider_config               Json?
  cross_division_query_enabled     Boolean       @default(false)
  auto_summary_chat                Boolean       @default(false)
  created_at                       DateTime      @default(now())

  users                            User[]
  divisions                        Division[]
  feature_flags                    FeatureFlag[]
  documents                        Document[]
  contents                         Content[]
  quizzes                          Quiz[]
  faqs                             FAQ[]
  user_points                      UserPoints[]
  subscriptions                    Subscription[]
  invoices                         Invoice[]
  ai_usage_logs                    AIUsageLog[]

  @@map("organizations")
}

model FeatureFlag {
  id               String       @id @default(uuid())
  organization_id  String
  flag_key         String
  is_enabled       Boolean      @default(true)
  created_at       DateTime     @default(now())

  organization     Organization @relation(fields: [organization_id], references: [id], onDelete: Cascade)

  @@unique([organization_id, flag_key])
  @@map("feature_flags")
}

model User {
  id               String        @id // Maps to Supabase auth.users UUID
  organization_id  String
  full_name        String
  job_title        String?
  avatar_url       String?
  is_active        Boolean       @default(true)
  created_at       DateTime      @default(now())

  organization     Organization  @relation(fields: [organization_id], references: [id], onDelete: Cascade)
  user_divisions   UserDivision[]
  quiz_results     QuizResult[]
  read_trackers    ReadTracker[]
  user_points      UserPoints?
  notifications    Notification[]
  ai_usage_logs    AIUsageLog[]
  chat_sessions    ChatSession[]

  @@map("users")
}

model Division {
  id               String        @id @default(uuid())
  organization_id  String
  name             String
  description      String?
  created_at       DateTime      @default(now())

  organization     Organization  @relation(fields: [organization_id], references: [id], onDelete: Cascade)
  user_divisions   UserDivision[]
  documents        Document[]
  contents         Content[]
  quizzes          Quiz[]
  faqs             FAQ[]

  @@map("divisions")
}

model UserDivision {
  id               String   @id @default(uuid())
  user_id          String
  division_id      String
  role             Role
  is_primary       Boolean  @default(false)

  user             User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  division         Division @relation(fields: [division_id], references: [id], onDelete: Cascade)

  @@unique([user_id, division_id])
  @@index([user_id])
  @@index([division_id])
  @@map("user_divisions")
}

model Document {
  id                 String          @id @default(uuid())
  organization_id    String
  division_id        String
  uploaded_by        String
  file_name          String
  file_path          String
  file_size          Int
  mime_type          String
  ai_title           String?
  ai_summary         String?         @db.Text
  ai_tags            String[]
  protection_config  Json?
  is_processed       Boolean         @default(false)
  processing_status  String          @default("idle") // idle, processing, completed, failed
  processing_log     Json?           // Array of {time, message, progress}
  embedding_model    String?         // 'text-embedding-004' | 'nomic-embed-text'
  embedding_version  Int             @default(0)
  processing_error   String?         @db.Text
  created_at         DateTime        @default(now())

  organization     Organization    @relation(fields: [organization_id], references: [id], onDelete: Cascade)
  division         Division        @relation(fields: [division_id], references: [id], onDelete: Cascade)
  chunks           DocumentChunk[]

  @@index([organization_id])
  @@index([division_id])
  @@map("documents")
}

model DocumentChunk {
  id               String    @id @default(uuid())
  document_id      String
  chunk_index      Int
  content          String    @db.Text
  embedding        Unsupported("vector(768)")?
  token_count      Int
  page_number      Int?
  page_end         Int?
  created_at       DateTime  @default(now())

  document         Document @relation(fields: [document_id], references: [id], onDelete: Cascade)

  @@index([document_id])
  @@map("document_chunks")
}

model Content {
  id                 String             @id @default(uuid())
  organization_id    String
  division_id        String?
  author_id          String
  title              String
  body               String             @db.Text
  category           String
  status             ContentStatus      @default(DRAFT)
  is_mandatory_read  Boolean            @default(false)
  source_documents   String[]
  created_at         DateTime           @default(now())
  published_at       DateTime?

  organization       Organization       @relation(fields: [organization_id], references: [id], onDelete: Cascade)
  division           Division?          @relation(fields: [division_id], references: [id], onDelete: Cascade)
  versions           ContentVersion[]
  approval_queues    ApprovalQueue[]
  suggestions        RevisionSuggestion[]
  quizzes            Quiz[]
  read_trackers      ReadTracker[]

  @@index([organization_id])
  @@index([status])
  @@map("contents")
}

model ContentVersion {
  id               String   @id @default(uuid())
  content_id       String
  body             String   @db.Text
  changed_by       String
  change_note      String?  @db.Text
  created_at       DateTime @default(now())

  content          Content  @relation(fields: [content_id], references: [id], onDelete: Cascade)

  @@index([content_id])
  @@map("content_versions")
}

model ApprovalQueue {
  id               String         @id @default(uuid())
  content_id       String
  submitted_by     String
  reviewed_by      String?
  status           ApprovalStatus @default(PENDING)
  reviewer_note    String?        @db.Text
  submitted_at     DateTime       @default(now())
  reviewed_at      DateTime?

  content          Content        @relation(fields: [content_id], references: [id], onDelete: Cascade)

  @@index([content_id])
  @@index([status])
  @@map("approval_queues")
}

model RevisionSuggestion {
  id               String           @id @default(uuid())
  content_id       String
  suggested_by     String
  suggestion_text  String           @db.Text
  status           SuggestionStatus @default(PENDING)
  reviewed_by      String?
  created_at       DateTime         @default(now())

  content          Content          @relation(fields: [content_id], references: [id], onDelete: Cascade)

  @@index([content_id])
  @@map("revision_suggestions")
}

model Quiz {
  id                 String         @id @default(uuid())
  organization_id    String
  division_id        String
  created_by         String
  title              String
  description        String?        @db.Text
  time_limit_minutes Int?
  is_published       Boolean        @default(false)
  content_id         String?
  created_at         DateTime       @default(now())

  organization       Organization   @relation(fields: [organization_id], references: [id], onDelete: Cascade)
  division           Division       @relation(fields: [division_id], references: [id], onDelete: Cascade)
  content            Content?       @relation(fields: [content_id], references: [id], onDelete: Cascade)
  questions          QuizQuestion[]
  results            QuizResult[]

  @@index([organization_id])
  @@map("quizzes")
}

model QuizQuestion {
  id               String   @id @default(uuid())
  quiz_id          String
  question_text    String   @db.Text
  question_type    String   // MULTIPLE_CHOICE | TRUE_FALSE
  options          Json
  correct_answer   String
  order_index      Int

  quiz             Quiz     @relation(fields: [quiz_id], references: [id], onDelete: Cascade)

  @@index([quiz_id])
  @@map("quiz_questions")
}

model QuizResult {
  id               String   @id @default(uuid())
  quiz_id          String
  user_id          String
  score            Int
  answers          Json
  completed_at     DateTime @default(now())

  quiz             Quiz     @relation(fields: [quiz_id], references: [id], onDelete: Cascade)
  user             User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([quiz_id])
  @@index([user_id])
  @@map("quiz_results")
}

model ReadTracker {
  id               String    @id @default(uuid())
  user_id          String
  content_id       String
  is_confirmed     Boolean   @default(false)
  confirmed_at     DateTime?
  points_awarded   Int       @default(0)

  user             User      @relation(fields: [user_id], references: [id], onDelete: Cascade)
  content          Content   @relation(fields: [content_id], references: [id], onDelete: Cascade)

  @@unique([user_id, content_id])
  @@map("read_trackers")
}

model UserPoints {
  id               String   @id @default(uuid())
  user_id          String   @unique
  organization_id  String
  total_points     Int      @default(0)
  updated_at       DateTime @default(now()) @updatedAt

  user             User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  organization     Organization @relation(fields: [organization_id], references: [id], onDelete: Cascade)

  @@index([organization_id])
  @@map("user_points")
}

model FAQ {
  id               String       @id @default(uuid())
  organization_id  String
  division_id      String
  created_by       String
  question         String       @db.Text
  answer           String       @db.Text
  order_index      Int
  created_at       DateTime     @default(now())

  organization     Organization @relation(fields: [organization_id], references: [id], onDelete: Cascade)
  division         Division     @relation(fields: [division_id], references: [id], onDelete: Cascade)

  @@index([organization_id])
  @@map("faqs")
}

model Notification {
  id               String           @id @default(uuid())
  user_id          String
  type             NotificationType
  title            String
  message          String           @db.Text
  is_read          Boolean          @default(false)
  reference_id     String?
  reference_type   String?
  created_at       DateTime         @default(now())

  user             User             @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([is_read])
  @@map("notifications")
}

model Subscription {
  id               String       @id @default(uuid())
  organization_id  String
  plan_name        String
  started_at       DateTime
  expires_at       DateTime
  is_active        Boolean      @default(true)

  organization     Organization @relation(fields: [organization_id], references: [id], onDelete: Cascade)

  @@index([organization_id])
  @@map("subscriptions")
}

model Invoice {
  id               String       @id @default(uuid())
  organization_id  String
  amount           Decimal
  currency         String
  period_start     DateTime
  period_end       DateTime
  invoice_pdf_path String?
  created_at       DateTime     @default(now())

  organization     Organization @relation(fields: [organization_id], references: [id], onDelete: Cascade)

  @@index([organization_id])
  @@map("invoices")
}

model AIUsageLog {
  id               String       @id @default(uuid())
  organization_id  String
  user_id          String
  action_type      String       // AUTO_TAG | SUMMARIZE | DRAFT_GENERATE | CHAT_QUERY
  tokens_used      Int
  model_used       String
  created_at       DateTime     @default(now())

  organization     Organization @relation(fields: [organization_id], references: [id], onDelete: Cascade)
  user             User         @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([organization_id])
  @@index([user_id])
  @@map("ai_usage_logs")
}

model ChatSession {
  id              String        @id @default(uuid())
  user_id         String
  organization_id String
  title           String        @default("New Chat")
  summary         String?       @db.Text
  created_at      DateTime      @default(now())
  updated_at      DateTime      @default(now()) @updatedAt

  user            User          @relation(fields: [user_id], references: [id], onDelete: Cascade)
  messages        ChatMessage[]

  @@index([user_id])
  @@index([organization_id])
  @@map("chat_sessions")
}

model ChatMessage {
  id              String      @id @default(uuid())
  session_id      String
  role            String      // 'user' | 'assistant'
  content         String      @db.Text
  citations       Json?
  created_at      DateTime    @default(now())

  session         ChatSession @relation(fields: [session_id], references: [id], onDelete: Cascade)

  @@index([session_id])
  @@map("chat_messages")
}
